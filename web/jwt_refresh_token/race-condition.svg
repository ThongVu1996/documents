<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 750" style="background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);">
  <defs>
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    <marker id="arrowBlue" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L10,3 z" fill="#4299e1" />
    </marker>
    <marker id="arrowRed" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L10,3 z" fill="#fc8181" />
    </marker>
    <marker id="arrowPurple" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L10,3 z" fill="#9f7aea" />
    </marker>
    <marker id="arrowOrange" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L10,3 z" fill="#ed8936" />
    </marker>
    <marker id="arrowGreen" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L10,3 z" fill="#48bb78" />
    </marker>
  </defs>

  <style>
    .title { font-family: 'Segoe UI', sans-serif; font-size: 28px; fill: #e2e8f0; font-weight: 700; }
    .subtitle { font-family: 'Segoe UI', sans-serif; font-size: 16px; fill: #a0aec0; }
    .node-text { font-family: 'Segoe UI', sans-serif; font-size: 14px; fill: #1a202c; font-weight: 700; }
    .node-text-light { font-family: 'Segoe UI', sans-serif; font-size: 16px; fill: #e2e8f0; font-weight: 700; }
    .step-num { font-family: 'Segoe UI', sans-serif; font-size: 12px; fill: #fff; font-weight: 700; }
    .step-text { font-family: 'Segoe UI', sans-serif; font-size: 11px; fill: #cbd5e0; font-weight: 500; }
    .sidebar-title { font-family: 'Segoe UI', sans-serif; font-size: 18px; fill: #fc8181; font-weight: 600; text-decoration: underline; }
    .sidebar-text { font-family: 'Segoe UI', sans-serif; font-size: 13px; fill: #718096; transition: all 0.5s; }
    
    /* Animation Cycle: 16s */
    .s1 { opacity: 0.1; animation: hlBlue 16s ease-in-out infinite; animation-delay: 0s; } /* Req A */
    .s2 { opacity: 0.1; animation: hlRed 16s ease-in-out infinite; animation-delay: 2s; }  /* Lock */
    .s3 { opacity: 0.1; animation: hlOrange 16s ease-in-out infinite; animation-delay: 4s; } /* Req B, C Wait */
    .s4 { opacity: 0.1; animation: hlPurple 16s ease-in-out infinite; animation-delay: 6s; } /* Refresh Call */
    .s5 { opacity: 0.1; animation: hlGreen 16s ease-in-out infinite; animation-delay: 8s; } /* Return New Tokens */
    .s6 { opacity: 0.1; animation: hlRed 16s ease-in-out infinite; animation-delay: 10s; } /* Resolve Promise (Unlock) */
    .s7 { opacity: 0.1; animation: hlBlue 16s ease-in-out infinite; animation-delay: 12s; } /* All Retry Success */

    /* Text Highlight Animations (Sidebar) */
    .txt-s1 { animation: txtHlBlue 16s ease-in-out infinite; animation-delay: 0s; }
    .txt-s2 { animation: txtHlRed 16s ease-in-out infinite; animation-delay: 2s; }
    .txt-s3 { animation: txtHlOrange 16s ease-in-out infinite; animation-delay: 4s; }
    .txt-s4 { animation: txtHlPurple 16s ease-in-out infinite; animation-delay: 6s; }
    .txt-s5 { animation: txtHlGreen 16s ease-in-out infinite; animation-delay: 8s; }
    .txt-s6 { animation: txtHlRed 16s ease-in-out infinite; animation-delay: 10s; }
    .txt-s7 { animation: txtHlBlue 16s ease-in-out infinite; animation-delay: 12s; }

    @keyframes hlBlue { 0%,8% { opacity:1; filter:drop-shadow(0 0 8px rgba(66,153,225,1)); stroke-width:3; } 9%,100% { opacity:0.1; stroke-width:1; } }
    @keyframes hlPurple { 0%,8% { opacity:1; filter:drop-shadow(0 0 8px rgba(159,122,234,1)); stroke-width:3; } 9%,100% { opacity:0.1; stroke-width:1; } }
    @keyframes hlRed { 0%,8% { opacity:1; filter:drop-shadow(0 0 8px rgba(252,129,129,1)); stroke-width:3; } 9%,100% { opacity:0.1; stroke-width:1; } }
    @keyframes hlGreen { 0%,8% { opacity:1; filter:drop-shadow(0 0 8px rgba(72,187,120,1)); stroke-width:3; } 9%,100% { opacity:0.1; stroke-width:1; } }
    @keyframes hlOrange { 0%,8% { opacity:1; filter:drop-shadow(0 0 8px rgba(237,137,54,1)); stroke-width:3; } 9%,100% { opacity:0.1; stroke-width:1; } }

    @keyframes txtHlBlue { 0%,8% { fill: #63b3ed; font-weight:700; transform: translateX(10px); } 9%,100% { fill: #718096; transform: translateX(0); } }
    @keyframes txtHlPurple { 0%,8% { fill: #b794f4; font-weight:700; transform: translateX(10px); } 9%,100% { fill: #718096; transform: translateX(0); } }
    @keyframes txtHlRed { 0%,8% { fill: #fc8181; font-weight:700; transform: translateX(10px); } 9%,100% { fill: #718096; transform: translateX(0); } }
    @keyframes txtHlGreen { 0%,8% { fill: #68d391; font-weight:700; transform: translateX(10px); } 9%,100% { fill: #718096; transform: translateX(0); } }
    @keyframes txtHlOrange { 0%,8% { fill: #fbd38d; font-weight:700; transform: translateX(10px); } 9%,100% { fill: #718096; transform: translateX(0); } }

    .indicator { animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.2); } }
    
    .lock-icon { transform-origin: center; animation: lockAnim 16s ease-in-out infinite; }
    @keyframes lockAnim { 
      0%, 10% { opacity: 0; transform: scale(0.5); }
      12%, 60% { opacity: 1; transform: scale(1); fill: #fc8181; }
      62%, 100% { opacity: 0; transform: scale(0.5); } 
    }
  </style>

  <text x="700" y="50" text-anchor="middle" class="title">Race Condition Handler</text>
  <text x="700" y="75" text-anchor="middle" class="subtitle">"Promise Singleton" Pattern (Request De-duplication)</text>

  <g transform="translate(50, 100)">
    <rect x="0" y="0" width="280" height="500" rx="10" fill="rgba(30, 30, 40, 0.5)" stroke="#2d3748" />
    <text x="20" y="40" class="sidebar-title">Concurrency Flow</text>
    <text x="20" y="80" class="sidebar-text txt-s1">1. Request A arrives (First)</text>
    <text x="20" y="120" class="sidebar-text txt-s2">2. Token Expired -> Create Lock</text>
    
    <text x="20" y="160" class="sidebar-text txt-s3">3. Req B &amp; C arrive -> WAIT</text>
    
    <text x="20" y="200" class="sidebar-text txt-s4">4. Only A calls Refresh API</text>
    <text x="20" y="240" class="sidebar-text txt-s5">5. Backend returns New Token</text>
    <text x="20" y="280" class="sidebar-text txt-s6">6. Resolve Lock (Distribute Token)</text>
    <text x="20" y="320" class="sidebar-text txt-s7">7. A, B, C Retry Success</text>
  </g>

  <g transform="translate(350, 0)">
    
    <g transform="translate(0, 150)">
      <text x="60" y="30" text-anchor="middle" class="node-text-light">Client</text>
      
      <circle cx="20" cy="80" r="15" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
      <text x="20" y="85" text-anchor="middle" style="fill:#4299e1; font-weight:bold; font-size:12px">A</text>
      
      <circle cx="20" cy="160" r="15" fill="#2d3748" stroke="#ed8936" stroke-width="2"/>
      <text x="20" y="165" text-anchor="middle" style="fill:#ed8936; font-weight:bold; font-size:12px">B</text>
      
      <circle cx="20" cy="240" r="15" fill="#2d3748" stroke="#ed8936" stroke-width="2"/>
      <text x="20" y="245" text-anchor="middle" style="fill:#ed8936; font-weight:bold; font-size:12px">C</text>
    </g>

    <g transform="translate(350, 100)">
      <rect x="0" y="0" width="220" height="380" rx="15" fill="#2d3748" stroke="#fc8181" stroke-width="3"/>
      <text x="110" y="30" text-anchor="middle" class="node-text-light">BFF (Memory)</text>
      
      <g transform="translate(110, 130)">
        <circle cx="0" cy="0" r="60" fill="rgba(0,0,0,0.3)" stroke="#555" stroke-dasharray="4,4"/>
        <text x="0" y="-75" text-anchor="middle" class="step-text" font-weight="bold" fill="#fc8181">Promise&lt;Token&gt;</text>
        <path d="M-15,-10 L-15,-20 Q-15,-35 0,-35 Q15,-35 15,-20 L15,-10 L20,-10 L20,20 L-20,20 L-20,-10 Z" class="lock-icon" fill="#555"/>
      </g>
      
      <g transform="translate(0, 0)"> 
          <text x="110" y="190" text-anchor="middle" class="step-text s3" fill="#ed8936">Queue (Waiting)</text>
          
          <circle cx="90" cy="210" r="12" fill="#ed8936" class="s3"/> 
          <text x="90" y="214" text-anchor="middle" class="step-num s3">B</text>
          
          <circle cx="130" cy="290" r="12" fill="#ed8936" class="s3"/> 
          <text x="130" y="294" text-anchor="middle" class="step-num s3">C</text>
      </g>
    </g>

    <g transform="translate(850, 150)">
      <rect x="0" y="0" width="150" height="250" rx="15" fill="#c6f6d5" stroke="#48bb78" stroke-width="3"/>
      <text x="75" y="40" text-anchor="middle" class="node-text">Backend</text>
      <text x="75" y="125" text-anchor="middle" style="font-size:40px">‚öôÔ∏è</text>
    </g>

    <path d="M 50 230 L 350 230" stroke="#4299e1" stroke-width="2" class="s1" fill="none" marker-end="url(#arrowBlue)"/>
    <g transform="translate(200, 220)" class="s1"><circle r="10" fill="#4299e1" class="indicator"/><text x="0" y="4" text-anchor="middle" class="step-num">1</text></g>
    <text x="200" y="215" text-anchor="middle" class="step-text s1">Req A (First)</text>

    <g transform="translate(460, 230)" class="s2">
        <text x="0" y="5" text-anchor="middle" class="step-num" stroke="#000" stroke-width="3" stroke-opacity="0.5" paint-order="stroke">üîí 2. Lock Created</text>
    </g>

    <path d="M 50 310 L 350 310" stroke="#ed8936" stroke-width="2" class="s3" fill="none" marker-end="url(#arrowOrange)"/>
    <text x="200" y="300" text-anchor="middle" class="step-text s3">Req B (Wait)</text>
    
    <path d="M 50 390 L 350 390" stroke="#ed8936" stroke-width="2" class="s3" fill="none" marker-end="url(#arrowOrange)"/>
    <text x="200" y="380" text-anchor="middle" class="step-text s3">Req C (Wait)</text>

    <path d="M 570 260 L 850 260" stroke="#9f7aea" stroke-width="2" class="s4" fill="none" marker-end="url(#arrowPurple)"/>
    <g transform="translate(710, 250)" class="s4"><circle r="10" fill="#9f7aea" class="indicator"/><text x="0" y="4" text-anchor="middle" class="step-num">4</text></g>
    <text x="710" y="240" text-anchor="middle" class="step-text s4">SINGLE Refresh Call</text>

    <path d="M 850 310 L 570 310" stroke="#48bb78" stroke-width="2" class="s5" fill="none" marker-end="url(#arrowGreen)"/>
    <g transform="translate(710, 300)" class="s5"><circle r="10" fill="#48bb78" class="indicator"/><text x="0" y="4" text-anchor="middle" class="step-num">5</text></g>
    <text x="710" y="335" text-anchor="middle" class="step-text s5">New Token</text>

    <g transform="translate(460, 230)" class="s6">
        <text x="0" y="25" text-anchor="middle" class="step-num" stroke="#000" stroke-width="3" stroke-opacity="0.5" paint-order="stroke">üîì 6. Unlock &amp; Notify</text>
    </g>

    <path d="M 570 380 L 850 380" stroke="#4299e1" stroke-width="2" class="s7" fill="none" marker-end="url(#arrowBlue)"/>
    <g transform="translate(710, 370)" class="s7"><circle r="10" fill="#4299e1" class="indicator"/><text x="0" y="4" text-anchor="middle" class="step-num">7</text></g>
    <text x="710" y="400" text-anchor="middle" class="step-text s7">All Retry Success</text>

  </g>
</svg>